name: Dependabot Pull Request Approve and Merge
on: 
  - pull_request_target
  - workflow_dispatch
permissions:
  pull-requests: write
  contents: write
jobs:
  dependabot:
    runs-on: ubuntu-latest
    # Checking the actor will prevent your Action run failing on non-Dependabot
    # PRs but also ensures that it only does work for Dependabot PRs.
    #if: ${{ github.actor == 'dependabot[bot]' }}
    steps:
     # Checkout repo to make package allow list available
      - name: Checkout
        uses: actions/checkout@v2
                
      - name: Read list of Allowed Auto-merge Packages
        id: dependabot-allow-list
        run: |
          echo "::set-output name=dependabot-allow-list::$(yq .dependabot.allow-list .github/workflows/config/config.yml)\n"
          
      - name: Show yaml list
        run: |
          echo ${{ steps.dependabot-allow-list.outputs.dependabot-allow-list }}
          


        
      # This first step will fail if there's no metadata and so the approval
      # will not occur.
#       - name: Dependabot metadata
#         id: dependabot-metadata
#         uses: dependabot/fetch-metadata@v1.1.1
#         with:
#           github-token: "${{ secrets.GITHUB_TOKEN }}"
          
#       - name: Approve a PR
#         run: gh pr review --approve "$PR_URL"
#         env:
#           PR_URL: ${{ github.event.pull_request.html_url }}
#           GITHUB_TOKEN: ${{ secrets.VA_CMS_BOT_TOKEN }}
          
      # Finally, this sets the PR to allow auto-merging for patch and minor
      # updates if all checks pass
#       - name: Enable auto-merge for Dependabot PRs
#         if: ${{contains(steps.dependabot-metadata.outputs.dependency-names, 'va-gov/content-build')}}
#         run: gh pr merge --auto --squash "$PR_URL"
#         env:
#           PR_URL: ${{ github.event.pull_request.html_url }}
#           GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
